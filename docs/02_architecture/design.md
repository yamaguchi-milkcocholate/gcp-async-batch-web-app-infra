# Specification: PDF一括解析バッチ処理システム

## 1. 概要

本システムは、ユーザーがアップロードしたPDFファイルに対して、一気通貫で解析処理（テキスト抽出、マークダウン形式への変換・統合）を行うWebアプリケーションである。処理に長時間を要するため、非同期バッチ処理構成を採用し、ユーザーにはリアルタイムに進捗を可視化する。

## 2. ゴール

- **一気通貫処理**: ページごとの操作を不要にし、PDF全体を1回の操作で処理完了させる。
- **解析結果の統合**: マークダウン形式を含む解析結果を1つの成果物として統合・提供する。
- **データ管理の最小化**: セキュリティと管理の観点から、生成されたデータは一定期間（TTL）経過後に自動削除する。
- **ユーザー体験(UX)**: 最大30分程度の待機時間中、現在の進捗状況をリアルタイムに表示する。

## 3. システムアーキテクチャ (GCP)

- **Frontend**: Streamlit (Cloud Run)
- **Message Broker**: Cloud Pub/Sub (非同期実行のトリガー)
- **Batch Worker**: Python Processor (Cloud Run Jobs または Cloud Run)
- **State Store**: Cloud Memorystore for Redis (進捗ステータスの共有)
- **Object Storage**: Cloud Storage (PDFおよび結果ファイルの一時保管)

## 4. 機能要件

### 4.1. フロントエンド (Streamlit)

- PDFファイルのアップロード機能。
- バッチ処理の開始リクエスト送信（Pub/Subへのメッセージ発行）。
- Redisをポーリングし、処理ステータス（待機中、処理中、完了、エラー）と進捗率（%）を表示。
- 処理完了後、統合された結果ファイルのダウンロードボタンを表示。

### 4.2. バッチ処理 (Worker)

- Pub/Subメッセージをトリガーに起動。
- 指定されたGCSパスからPDFを読み込み、解析を実行。
- 解析の各ステップで、Redis上のステータスおよび進捗率を更新。
- 最終的なマークダウン統合ファイルを作成し、GCSに保存。
- 処理終了時にステータスを「完了」に更新。

### 4.3. データライフサイクル

- GCS上のバケットにライフサイクルルールを設定。
- アップロードされたPDFおよび生成された結果ファイルは、作成から24時間以内に自動削除。

## 5. ストレージ実装仕様（環境切り替え）

開発効率と本番環境の整合性を両立するため、ストレージ操作は抽象化レイヤーを介して行う。

### 5.1. ローカル開発環境

- **STORAGE_TYPE**: `LOCAL`
- **動作**: 外部エミュレータは使用せず、ローカルファイルシステム（`./local_storage`）をバケットに見立てて `shutil` 等でファイル操作を行う。これにより、エミュレータのセットアップコストを削減する。

### 5.2. 本番環境 (GCP)

- **STORAGE_TYPE**: `GCP`
- **動作**: `google-cloud-storage` ライブラリを使用し、実際のGCSバケットに対して操作を行う。

## 6. データ構造 (Redis)

キー形式: `job:{job_id}`

```json
{
  "status": "processing",
  "progress": 45,
  "message": "Page 5/12 analyzing...",
  "result_url": "",
  "error_msg": "",
  "updated_at": "2026-02-12T05:43:00Z"
}
```

## 7. ローカル開発構成 (Docker Compose)

- **app**: Streamlitコンテナ
- **worker**: 解析処理コンテナ
- **redis**: `redis:7-alpine`
- **pubsub**: `gcr.io/google.com/cloudsdktool/cloud-sdk:emulators` (Pub/Subエミュレータ)
- **storage**: `./local_storage` を各コンテナにボリュームマウント

## 8. 非機能要件

- **タイムアウト**: Cloud Runのタイムアウト制限（最大60分）に準拠した設計。
- **リトライ**: バッチ処理失敗時、Pub/Subのデッドレターポリシーによる再試行検討。
- **スケーラビリティ**: 複数ユーザーが同時にアップロードした場合でも、Pub/Subによるキューイングで負荷を制御。
