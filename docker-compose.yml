version: '3.8'

services:
  # Streamlit フロントエンドアプリケーション
  app:
    build:
      context: ./apps/streamlit-app
      dockerfile: Dockerfile
    ports:
      - "8501:8501"
    volumes:
      # Hot Reload 対応: ソースコードをマウント
      - ./apps/streamlit-app:/app
      # ローカルストレージをマウント
      - ./local_storage:/app/local_storage
    environment:
      - STORAGE_TYPE=LOCAL
      - LOCAL_STORAGE_PATH=./local_storage
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=0
      - PUBSUB_EMULATOR_HOST=pubsub:8085
      - PUBSUB_TOPIC=pdf-processing-topic
      - GCP_PROJECT_ID=local-dev
    depends_on:
      - redis
      - pubsub
    networks:
      - app-network

  # Redis - ステータス管理用
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    command: redis-server --save ""
    networks:
      - app-network

  # Pub/Sub エミュレータ
  pubsub:
    image: gcr.io/google.com/cloudsdktool/cloud-sdk:emulators
    ports:
      - "8085:8085"
    command: >
      sh -c "
        gcloud beta emulators pubsub start --host-port=0.0.0.0:8085 --project=local-dev &
        echo 'Waiting for Pub/Sub emulator to start...' &&
        for i in 1 2 3 4 5 6 7 8 9 10; do
          sleep 2 &&
          curl -s http://localhost:8085/v1/projects/local-dev/topics && break ||
          echo 'Retry '$$i'...'
        done &&
        echo 'Creating topic...' &&
        curl -X PUT http://localhost:8085/v1/projects/local-dev/topics/pdf-processing-topic &&
        echo 'Creating subscription...' &&
        curl -X PUT http://localhost:8085/v1/projects/local-dev/subscriptions/pdf-processing-subscription -H 'Content-Type: application/json' -d '{\"topic\": \"projects/local-dev/topics/pdf-processing-topic\", \"ackDeadlineSeconds\": 600}' &&
        echo 'Pub/Sub emulator ready' &&
        tail -f /dev/null
      "
    networks:
      - app-network

  # バッチワーカー
  worker:
    build:
      context: ./apps/batch-worker
      dockerfile: Dockerfile
    volumes:
      # Hot Reload 対応: ソースコードをマウント
      - ./apps/batch-worker:/app
      # ローカルストレージをマウント
      - ./local_storage:/app/local_storage
    environment:
      - STORAGE_TYPE=LOCAL
      - LOCAL_STORAGE_PATH=./local_storage
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=0
      - PUBSUB_EMULATOR_HOST=pubsub:8085
      - PUBSUB_SUBSCRIPTION=pdf-processing-subscription
      - GCP_PROJECT_ID=local-dev
    depends_on:
      - redis
      - pubsub
    networks:
      - app-network
    deploy:
      replicas: 3  # 3つのワーカーを並列起動

networks:
  app-network:
    driver: bridge

volumes:
  local_storage:
